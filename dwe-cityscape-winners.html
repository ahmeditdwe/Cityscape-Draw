<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>City Scape 2025 Winner - Dar Wa Emaar</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, where, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDwQsyhYlYNt7kmJIl8QfqvzArLHScPMog",
            authDomain: "cityscape-winner.firebaseapp.com",
            projectId: "cityscape-winner",
            storageBucket: "cityscape-winner.firebasestorage.app",
            messagingSenderId: "471774865123",
            appId: "1:471774865123:web:d1c9aae59e6e43385c87d6",
            measurementId: "G-HVQD9D3FY8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);

        // Make Firebase services available globally
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseAuthFunctions = { signInWithEmailAndPassword, signOut, onAuthStateChanged };
        window.firestoreFunctions = { collection, doc, setDoc, getDoc, getDocs, query, where, serverTimestamp };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', 'Cairo', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .particle {
            position: absolute;
            background: #F27935;
            border-radius: 50%;
            opacity: 0.3;
            animation: float 6s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 2;
        }

        .header {
            background: linear-gradient(135deg, #F27935 0%, #E86425 100%);
            color: white;
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            box-shadow: 0 15px 40px rgba(242, 121, 53, 0.4);
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.3; }
        }

        .logo-container {
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
            display: inline-block;
            background: black;
            padding: 20px 40px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .logo-svg {
            width: 180px;
            height: auto;
            display: block;
        }

        .bilingual-title {
            position: relative;
            z-index: 2;
        }

        .title-en {
            font-family: 'Poppins', sans-serif;
            font-size: 2.8em;
            margin: 10px 0;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            font-weight: 700;
        }

        .title-ar {
            font-family: 'Cairo', sans-serif;
            font-size: 2.5em;
            margin: 10px 0;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            font-weight: 700;
        }

        .subtitle {
            font-size: 1.3em;
            opacity: 0.95;
            margin-top: 10px;
        }

        /* Login Section Styles */
        .login-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 50px;
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 40px;
            text-align: center;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .login-title {
            font-size: 2em;
            color: #F27935;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .login-subtitle {
            font-size: 1.5em;
            color: #555;
            margin-bottom: 30px;
            font-weight: 600;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-group {
            text-align: left;
        }

        .input-label {
            display: block;
            font-size: 1.1em;
            color: #333;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }

        .input-field:focus {
            outline: none;
            border-color: #F27935;
            box-shadow: 0 0 0 3px rgba(242, 121, 53, 0.1);
        }

        .login-btn {
            background: linear-gradient(135deg, #F27935 0%, #E86425 100%);
            color: white;
            padding: 18px 50px;
            border: none;
            border-radius: 50px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(242, 121, 53, 0.4);
            font-weight: 600;
            margin-top: 10px;
        }

        .login-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(242, 121, 53, 0.5);
        }

        .login-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .logout-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
            font-weight: 600;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(220, 53, 69, 0.5);
        }

        .day-selector {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 40px;
            text-align: center;
        }

        .day-selector-title {
            font-size: 1.8em;
            color: #F27935;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .day-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .day-btn {
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
            color: #333;
            padding: 20px;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-family: 'Poppins', 'Cairo', sans-serif;
        }

        .day-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .day-btn.active {
            background: linear-gradient(135deg, #F27935 0%, #E86425 100%);
            color: white;
            border-color: #F27935;
            box-shadow: 0 8px 20px rgba(242, 121, 53, 0.4);
        }

        .day-btn.completed {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border-color: #4CAF50;
            position: relative;
        }

        .day-btn.completed::after {
            content: '‚úì';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5em;
        }

        .day-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .day-info {
            background: #fff8f4;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #F27935;
        }

        .day-info-text {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 10px;
        }

        .previous-winners {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 40px;
        }

        .previous-winners-title {
            font-size: 1.8em;
            color: #F27935;
            margin-bottom: 20px;
            font-weight: 700;
            text-align: center;
        }

        .winner-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .winner-item {
            background: linear-gradient(135deg, #f9f9f9 0%, #f5f5f5 100%);
            padding: 20px;
            border-radius: 15px;
            border-left: 5px solid #FFD700;
            transition: all 0.3s ease;
        }

        .winner-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.3);
        }

        .winner-day {
            font-size: 0.9em;
            color: #F27935;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .winner-name-item {
            font-size: 1.2em;
            color: #333;
            font-weight: 600;
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 50px;
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 40px;
            text-align: center;
        }

        .names-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 50px;
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 40px;
            animation: fadeIn 0.5s ease;
        }

        .names-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .names-title-en {
            font-family: 'Poppins', sans-serif;
            font-size: 2.5em;
            color: #333;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .names-title-ar {
            font-family: 'Cairo', sans-serif;
            font-size: 2.2em;
            color: #555;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .total-participants {
            font-size: 1.5em;
            color: #F27935;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .eligible-count {
            font-size: 1.3em;
            color: #28a745;
            font-weight: 600;
            margin-bottom: 20px;
            padding: 15px;
            background: #d4edda;
            border-radius: 10px;
            border-left: 4px solid #28a745;
        }

        .duplicates-info {
            font-size: 1.2em;
            color: #E86425;
            margin-bottom: 20px;
            padding: 15px;
            background: #fff8f4;
            border-radius: 10px;
            border-left: 4px solid #E86425;
        }

        .excluded-winners-section {
            margin-top: 20px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 10px;
            border-left: 4px solid #dc3545;
        }

        .excluded-winners-title {
            font-size: 1.4em;
            color: #721c24;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .excluded-winner-item {
            padding: 15px 20px;
            margin-bottom: 12px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
            animation: slideInLeft 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .excluded-winner-main {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .excluded-winner-icon {
            font-size: 1.8em;
            filter: grayscale(100%);
        }

        .excluded-winner-name {
            font-weight: 700;
            color: #721c24;
            font-size: 1.15em;
            flex: 1;
        }

        .excluded-winner-message {
            color: #856404;
            font-size: 1em;
            padding-left: 48px;
            line-height: 1.5;
        }

        .excluded-winner-message-ar {
            direction: rtl;
            padding-right: 48px;
            padding-left: 0;
            color: #856404;
            font-size: 0.95em;
        }

        .names-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 15px;
            margin-bottom: 40px;
            position: relative;
        }

        .names-grid::before {
            content: '‚úÖ Only eligible participants shown below (previous winners excluded)';
            display: block;
            grid-column: 1 / -1;
            padding: 12px;
            background: #d4edda;
            color: #155724;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            text-align: center;
            border: 2px solid #28a745;
        }

        .names-grid::-webkit-scrollbar {
            width: 10px;
        }

        .names-grid::-webkit-scrollbar-track {
            background: #e8e8e8;
            border-radius: 10px;
        }

        .names-grid::-webkit-scrollbar-thumb {
            background: #F27935;
            border-radius: 10px;
        }

        .names-grid::-webkit-scrollbar-thumb:hover {
            background: #E86425;
        }

        .name-item {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            border-left: 4px solid #F27935;
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            transition: all 0.3s ease;
            text-align: center;
            animation: fadeInScale 0.5s ease forwards;
            opacity: 0;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .name-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(242, 121, 53, 0.2);
        }

        .draw-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 50px;
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 40px;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        .draw-display {
            background: linear-gradient(135deg, #F27935 0%, #E86425 100%);
            padding: 80px 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .draw-name {
            font-size: 4em;
            color: white;
            font-weight: 700;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            font-family: 'Poppins', 'Cairo', sans-serif;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .draw-name.spinning {
            animation: spin 0.1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translateY(0); opacity: 1; }
            50% { transform: translateY(-30px); opacity: 0.5; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .choose-winner-btn {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #1a1a1a;
            padding: 25px 60px;
            border: none;
            border-radius: 50px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.5);
            font-weight: 700;
            font-family: 'Poppins', 'Cairo', sans-serif;
        }

        .choose-winner-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 40px rgba(255, 215, 0, 0.6);
        }

        .choose-winner-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .upload-area {
            border: 3px dashed #F27935;
            border-radius: 20px;
            padding: 70px 30px;
            background: linear-gradient(135deg, #fff8f4 0%, #fff0e8 100%);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .upload-area:hover {
            background: linear-gradient(135deg, #fff0e8 0%, #ffe8dc 100%);
            border-color: #E86425;
            transform: scale(1.02);
        }

        .upload-area.dragover {
            background: #ffe8dc;
            border-color: #E86425;
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(242, 121, 53, 0.3);
        }

        .upload-icon {
            font-size: 5em;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .upload-text {
            margin-bottom: 15px;
        }

        .upload-text-en {
            font-family: 'Poppins', sans-serif;
            font-size: 1.6em;
            color: #333;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .upload-text-ar {
            font-family: 'Cairo', sans-serif;
            font-size: 1.5em;
            color: #555;
            font-weight: 600;
        }

        #fileInput {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #F27935 0%, #E86425 100%);
            color: white;
            padding: 18px 50px;
            border: none;
            border-radius: 50px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(242, 121, 53, 0.4);
            font-weight: 600;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(242, 121, 53, 0.5);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .winner-section {
            display: none;
            animation: fadeInUp 0.8s ease;
        }

        .download-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
            font-weight: 600;
            margin: 20px 10px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .download-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(76, 175, 80, 0.5);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(40px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .announcement-banner {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #1a1a1a;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
            position: relative;
            overflow: hidden;
        }

        .announcement-banner::before {
            content: 'üéâ';
            position: absolute;
            font-size: 8em;
            opacity: 0.1;
            top: -20px;
            left: -20px;
            animation: rotate 10s linear infinite;
        }

        .announcement-banner::after {
            content: 'üéä';
            position: absolute;
            font-size: 8em;
            opacity: 0.1;
            bottom: -20px;
            right: -20px;
            animation: rotate 10s linear infinite reverse;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .announcement-text-en {
            font-family: 'Poppins', sans-serif;
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .announcement-text-ar {
            font-family: 'Cairo', sans-serif;
            font-size: 1.8em;
            font-weight: 700;
        }

        .winner-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            padding: 60px;
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
            border: 3px solid #F27935;
        }

        .winner-card::before {
            content: 'üëë';
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 4em;
            opacity: 0.1;
            animation: pulse 2s infinite;
        }

        .winner-trophy {
            text-align: center;
            font-size: 8em;
            margin-bottom: 30px;
            animation: bounce 2s infinite;
        }

        .winner-name-section {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, #fff8f4 0%, #fff0e8 100%);
            border-radius: 20px;
            border-left: 6px solid #F27935;
        }

        .name-label-en {
            font-family: 'Poppins', sans-serif;
            font-size: 1.3em;
            color: #666;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .name-label-ar {
            font-family: 'Cairo', sans-serif;
            font-size: 1.2em;
            color: #666;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .winner-name {
            font-size: 3.5em;
            color: #F27935;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            margin: 15px 0;
            font-family: 'Poppins', 'Cairo', sans-serif;
        }

        .winner-details {
            margin-bottom: 40px;
        }

        .detail-row {
            display: flex;
            align-items: center;
            padding: 25px;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #f9f9f9 0%, #f5f5f5 100%);
            border-radius: 15px;
            border-left: 5px solid #F27935;
            transition: all 0.3s ease;
        }

        .detail-row:hover {
            transform: translateX(10px);
            box-shadow: 0 5px 20px rgba(242, 121, 53, 0.2);
        }

        .detail-icon {
            font-size: 3em;
            margin-right: 25px;
            margin-left: 25px;
        }

        .detail-content {
            flex: 1;
        }

        .detail-label-en {
            font-family: 'Poppins', sans-serif;
            font-size: 1.1em;
            color: #666;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .detail-label-ar {
            font-family: 'Cairo', sans-serif;
            font-size: 1em;
            color: #888;
            margin-bottom: 10px;
        }

        .detail-value {
            font-size: 1.8em;
            color: #333;
            font-weight: 700;
            font-family: 'Poppins', 'Cairo', sans-serif;
            direction: ltr;
            text-align: left;
        }

        .prize-section {
            text-align: center;
            padding: 40px;
            background: linear-gradient(135deg, #F27935 0%, #E86425 100%);
            border-radius: 20px;
            color: white;
            margin-top: 40px;
            box-shadow: 0 15px 40px rgba(242, 121, 53, 0.4);
        }

        .prize-icon {
            font-size: 6em;
            margin-bottom: 20px;
            animation: shake 3s infinite;
        }

        .prize-car-image {
            max-width: 100%;
            width: 400px;
            height: auto;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            animation: shake 3s infinite;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .prize-icon-fallback {
            display: none;
            text-align: center;
            width: 100%;
        }

        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        .prize-label-en {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5em;
            margin-bottom: 10px;
            font-weight: 600;
            opacity: 0.95;
        }

        .prize-label-ar {
            font-family: 'Cairo', sans-serif;
            font-size: 1.4em;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .prize-text-en {
            font-family: 'Poppins', sans-serif;
            font-size: 2.2em;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            margin-bottom: 15px;
        }

        .prize-text-ar {
            font-family: 'Cairo', sans-serif;
            font-size: 2em;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #F27935;
            font-size: 1.5em;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .error {
            background: linear-gradient(135deg, #fee 0%, #fdd 100%);
            color: #c33;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 6px solid #c33;
            font-size: 1.1em;
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #F27935;
            position: absolute;
            animation: confettiFall 3s linear infinite;
        }

        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Winner Modal Popup */
        .winner-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            animation: modalFadeIn 0.5s ease;
        }

        .winner-modal.show {
            display: flex;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .winner-modal-content {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            padding: 60px 80px;
            border-radius: 30px;
            text-align: center;
            position: relative;
            max-width: 90%;
            max-height: 90vh;
            overflow: visible;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideUp 0.5s ease;
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(100px) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 2em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 300;
            line-height: 1;
        }

        .modal-close-btn:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: rotate(90deg);
        }

        .modal-trophy {
            font-size: 10em;
            margin-bottom: 30px;
            animation: bounce 2s infinite;
        }

        .modal-announcement {
            font-size: 3em;
            color: #1a1a1a;
            font-weight: 700;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            font-family: 'Poppins', sans-serif;
        }

        .modal-announcement-ar {
            font-size: 2.5em;
            color: #1a1a1a;
            font-weight: 700;
            margin-bottom: 40px;
            font-family: 'Cairo', sans-serif;
        }

        .modal-winner-name {
            font-size: 5em;
            color: #1a1a1a;
            font-weight: 700;
            margin: 30px 0;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
            font-family: 'Poppins', 'Cairo', sans-serif;
            padding: 30px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            animation: pulseGlow 2s infinite;
        }

        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            }
            50% {
                box-shadow: 0 0 40px rgba(255, 255, 255, 0.8);
            }
        }

        .modal-congrats {
            font-size: 2.5em;
            color: #1a1a1a;
            font-weight: 700;
            margin: 30px 0;
            font-family: 'Poppins', sans-serif;
        }

        .modal-congrats-ar {
            font-size: 2.2em;
            color: #1a1a1a;
            font-weight: 700;
            margin-bottom: 40px;
            font-family: 'Cairo', sans-serif;
        }

        .modal-close-text {
            font-size: 1.3em;
            color: rgba(26, 26, 26, 0.8);
            margin-top: 30px;
            font-weight: 600;
            animation: blink 2s infinite;
            cursor: pointer;
        }

        @keyframes blink {
            0%, 50%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.5; }
        }

        @media (max-width: 768px) {
            .winner-modal-content {
                padding: 40px 30px;
            }

            .modal-trophy {
                font-size: 6em;
            }

            .modal-announcement {
                font-size: 2em;
            }

            .modal-announcement-ar {
                font-size: 1.8em;
            }

            .modal-winner-name {
                font-size: 3em;
                padding: 20px;
            }

            .modal-congrats {
                font-size: 1.8em;
            }

            .modal-congrats-ar {
                font-size: 1.6em;
            }

            .modal-close-btn {
                width: 40px;
                height: 40px;
                font-size: 1.5em;
            }
        }

        /* Large screens - compact layout */
        @media (min-width: 1200px) {
            .winner-card {
                padding: 40px;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 30px;
                align-items: start;
            }

            .winner-trophy {
                grid-column: 1 / -1;
                font-size: 5em;
                margin-bottom: 10px;
            }

            .winner-name-section {
                grid-column: 1 / -1;
                margin-bottom: 20px;
                padding: 20px;
            }

            .winner-name {
                font-size: 2.8em;
            }

            .winner-details {
                margin-bottom: 0;
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            .detail-row {
                padding: 20px;
                margin-bottom: 0;
            }

            .detail-value {
                font-size: 1.5em;
            }

            .prize-section {
                padding: 30px;
                margin-top: 0;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            .prize-icon {
                font-size: 5em;
                margin-bottom: 15px;
            }

            .prize-car-image {
                width: 100%;
                max-width: 350px;
                margin-bottom: 15px;
            }

            .prize-text-en {
                font-size: 1.8em;
                margin-bottom: 10px;
            }

            .prize-text-ar {
                font-size: 1.6em;
            }

            .announcement-banner {
                padding: 25px;
            }

            .announcement-text-en {
                font-size: 1.8em;
            }

            .announcement-text-ar {
                font-size: 1.6em;
            }
        }

        /* Extra large screens */
        @media (min-width: 1600px) {
            .container {
                max-width: 1600px;
            }

            .winner-card {
                grid-template-columns: 1.2fr 0.8fr;
            }
        }

        @media (max-width: 768px) {
            .title-en { font-size: 2em; }
            .title-ar { font-size: 1.8em; }
            .upload-area { padding: 50px 20px; }
            .winner-card { padding: 40px 20px; }
            .winner-name { font-size: 2.5em; }
            .prize-text-en { font-size: 1.6em; }
            .prize-text-ar { font-size: 1.4em; }
            .detail-row {
                flex-direction: column;
                text-align: center;
            }
            .detail-icon {
                margin: 0 0 15px 0;
                font-size: 2.5em;
            }
            .detail-value {
                text-align: center;
                font-size: 1.5em;
            }
            .names-grid {
                grid-template-columns: 1fr;
                max-height: 300px;
            }
            .names-title-en {
                font-size: 2em;
            }
            .names-title-ar {
                font-size: 1.8em;
            }
            .draw-name {
                font-size: 2.5em;
            }
            .draw-display {
                padding: 60px 20px;
                min-height: 200px;
            }
            .choose-winner-btn {
                font-size: 1.2em;
                padding: 20px 40px;
            }
            .download-btn {
                font-size: 1em;
                padding: 12px 30px;
            }
            .prize-car-image {
                width: 100%;
                max-width: 280px;
            }
            .logout-btn {
                top: 10px;
                right: 10px;
                padding: 10px 20px;
                font-size: 0.9em;
            }
            .excluded-winner-item {
                flex-direction: column;
                text-align: center;
                gap: 8px;
                padding: 12px 15px;
            }
            .excluded-winner-main {
                flex-direction: column;
                gap: 8px;
            }
            .excluded-winner-message {
                padding-left: 0;
                font-size: 0.9em;
            }
            .excluded-winner-message-ar {
                padding-right: 0;
                font-size: 0.85em;
            }
        }

        /* Print styles */
        @media print {
            body {
                background: white;
                padding: 0;
            }

            .particles,
            .header,
            .upload-section,
            .names-section,
            .draw-section,
            .download-btn,
            .confetti,
            .logout-btn,
            .day-selector,
            .previous-winners,
            .winner-modal {
                display: none !important;
            }

            .winner-section {
                display: block !important;
                page-break-after: avoid;
            }

            .winner-card {
                box-shadow: none;
                border: 2px solid #F27935;
                page-break-inside: avoid;
            }

            .announcement-banner {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                page-break-inside: avoid;
            }

            .prize-section {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                page-break-inside: avoid;
            }

            .prize-car-image {
                max-width: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>
    
    <!-- Winner Modal Popup -->
    <div class="winner-modal" id="winnerModal">
        <div class="winner-modal-content">
            <button class="modal-close-btn" onclick="closeWinnerModal()">√ó</button>
            <div class="modal-trophy">üèÜ</div>
            <div class="modal-announcement">üéä WINNER üéä</div>
            <div class="modal-announcement-ar">ÿßŸÑŸÅÿßÿ¶ÿ≤</div>
            <div class="modal-winner-name" id="modalWinnerName">---</div>
            <div class="modal-congrats">CONGRATULATIONS!</div>
            <div class="modal-congrats-ar">ŸÖÿ®ÿ±ŸàŸÉ!</div>
            <div class="modal-close-text" onclick="closeWinnerModal()">
                Click anywhere or press ESC to view details ‚Ä¢ ÿßÿ∂ÿ∫ÿ∑ ŸÅŸä ÿ£Ÿä ŸÖŸÉÿßŸÜ ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ
            </div>
        </div>
    </div>
    
    <button class="logout-btn" id="logoutBtn" style="display:none;" onclick="handleLogout()">
        üö™ Logout ‚Ä¢ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
    </button>
    
    <div class="container">
        <!-- Login Section -->
        <div class="login-section" id="loginSection">
            <h2 class="login-title">üîê Admin Login</h2>
            <h3 class="login-subtitle">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑŸÖÿ¥ÿ±ŸÅ</h3>
            <form class="login-form" id="loginForm" onsubmit="handleLogin(event)">
                <div class="input-group">
                    <label class="input-label">Email ‚Ä¢ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</label>
                    <input type="email" class="input-field" id="emailInput" required placeholder="admin@darwaemaar.com">
                </div>
                <div class="input-group">
                    <label class="input-label">Password ‚Ä¢ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</label>
                    <input type="password" class="input-field" id="passwordInput" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="login-btn" id="loginBtn">
                    üîë Login ‚Ä¢ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                </button>
            </form>
        </div>

        <!-- Main Content (Hidden until authenticated) -->
        <div id="mainContent" style="display:none;">
            <div class="header">
                <div class="logo-container">
                    <img src="https://darwaemaar.com/wp-content/uploads/2023/05/DWE-Full-Colour-white.svg" alt="Dar Wa Emaar Logo" class="logo-svg">
                </div>
                <div class="bilingual-title">
                    <h1 class="title-en">City Scape 2025 Winner</h1>
                    <h1 class="title-ar">ÿßŸÑŸÅÿßÿ¶ÿ≤ ÿ®ÿ≥Ÿäÿ™Ÿä ÿ≥ŸÉŸäÿ® 2025</h1>
                    <p class="subtitle">üéâ Congratulations ‚Ä¢ ŸÖÿ®ÿ±ŸàŸÉ üéä</p>
                </div>
            </div>

            <!-- Day Selector -->
            <div class="day-selector" id="daySelector">
                <h2 class="day-selector-title">üìÖ Select Draw Day ‚Ä¢ ÿßÿÆÿ™ÿ± ŸäŸàŸÖ ÿßŸÑÿ≥ÿ≠ÿ®</h2>
                <div class="day-buttons" id="dayButtons">
                    <button class="day-btn" onclick="selectDay(1)" id="day1Btn">
                        Day 1 ‚Ä¢ ÿßŸÑŸäŸàŸÖ ÿßŸÑÿ£ŸàŸÑ
                    </button>
                    <button class="day-btn" onclick="selectDay(2)" id="day2Btn">
                        Day 2 ‚Ä¢ ÿßŸÑŸäŸàŸÖ ÿßŸÑÿ´ÿßŸÜŸä
                    </button>
                    <button class="day-btn" onclick="selectDay(3)" id="day3Btn">
                        Day 3 ‚Ä¢ ÿßŸÑŸäŸàŸÖ ÿßŸÑÿ´ÿßŸÑÿ´
                    </button>
                    <button class="day-btn" onclick="selectDay(4)" id="day4Btn">
                        Day 4 ‚Ä¢ ÿßŸÑŸäŸàŸÖ ÿßŸÑÿ±ÿßÿ®ÿπ
                    </button>
                </div>
                <div class="day-info" id="dayInfo" style="display:none;">
                    <div class="day-info-text" id="dayInfoText"></div>
                </div>
            </div>

            <!-- Previous Winners -->
            <div class="previous-winners" id="previousWinnersSection" style="display:none;">
                <h2 class="previous-winners-title">üèÜ Previous Winners ‚Ä¢ ÿßŸÑŸÅÿßÿ¶ÿ≤ŸàŸÜ ÿßŸÑÿ≥ÿßÿ®ŸÇŸàŸÜ</h2>
                <div class="winner-list" id="previousWinnersList"></div>
            </div>

            <div class="upload-section">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üèÜ</div>
                    <div class="upload-text">
                        <h3 class="upload-text-en">Upload Winner Excel File</h3>
                        <h3 class="upload-text-ar">ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ ÿßŸÑŸÅÿßÿ¶ÿ≤</h3>
                    </div>
                    <button class="btn" onclick="document.getElementById('fileInput').click()">
                        üìÇ Select File ‚Ä¢ ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸÑŸÅ
                    </button>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleFile(event)">
                </div>
            </div>

            <div id="loading" class="loading" style="display:none;">
                <p>üîÑ Processing... ‚Ä¢ ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©...</p>
            </div>

            <div id="error" class="error" style="display:none;"></div>

            <div class="names-section" id="namesSection">
                <div class="names-header">
                    <h2 class="names-title-en">Eligible Participants for Draw</h2>
                    <h2 class="names-title-ar">ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉŸäŸÜ ÿßŸÑŸÖÿ§ŸáŸÑŸäŸÜ ŸÑŸÑÿ≥ÿ≠ÿ®</h2>
                    <div class="total-participants">
                        <span id="totalCount">0</span> Eligible ‚Ä¢ ŸÖÿ§ŸáŸÑ
                    </div>
                    <div class="eligible-count" id="eligibleCount" style="display:none;"></div>
                    <div class="duplicates-info" id="duplicatesInfo" style="display:none;"></div>
                </div>
                <div class="names-grid" id="namesGrid"></div>
                <div style="text-align: center;">
                    <button class="choose-winner-btn" onclick="startDraw()">
                        üé≤ Choose Winner ‚Ä¢ ÿßÿÆÿ™ÿ± ÿßŸÑŸÅÿßÿ¶ÿ≤ üé≤
                    </button>
                </div>
            </div>

            <div class="draw-section" id="drawSection">
                <div class="draw-display">
                    <div class="draw-name" id="drawName">---</div>
                </div>
                <button class="choose-winner-btn" id="drawBtn" onclick="startDraw()" disabled>
                    üé≤ Drawing... ‚Ä¢ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≥ÿ≠ÿ®... üé≤
                </button>
            </div>

            <div class="winner-section" id="winnerSection">
                <div class="announcement-banner">
                    <div class="announcement-text-en">üéä WINNER ANNOUNCEMENT üéä</div>
                    <div class="announcement-text-ar">ÿ•ÿπŸÑÿßŸÜ ÿßŸÑŸÅÿßÿ¶ÿ≤</div>
                </div>

                <div class="winner-card">
                    <div class="winner-trophy">üèÜ</div>
                    
                    <div class="winner-name-section">
                        <div class="name-label-en">Winner Name</div>
                        <div class="name-label-ar">ÿßÿ≥ŸÖ ÿßŸÑŸÅÿßÿ¶ÿ≤</div>
                        <div class="winner-name" id="winnerName">---</div>
                    </div>

                    <div class="winner-details">
                        <div class="detail-row">
                            <div class="detail-icon">üì±</div>
                            <div class="detail-content">
                                <div class="detail-label-en">Mobile Number</div>
                                <div class="detail-label-ar">ÿ±ŸÇŸÖ ÿßŸÑÿ¨ŸàÿßŸÑ</div>
                                <div class="detail-value" id="mobileNumber">---</div>
                            </div>
                        </div>
                        <div class="detail-row" id="leadNumberRow" style="display:none;">
                            <div class="detail-icon">üî¢</div>
                            <div class="detail-content">
                                <div class="detail-label-en">Lead Number</div>
                                <div class="detail-label-ar">ÿ±ŸÇŸÖ ÿßŸÑÿπŸÖŸäŸÑ ÿßŸÑŸÖÿ≠ÿ™ŸÖŸÑ</div>
                                <div class="detail-value" id="leadNumber">---</div>
                            </div>
                        </div>
                        <div class="detail-row" id="projectRow" style="display:none;">
                            <div class="detail-icon">üè¢</div>
                            <div class="detail-content">
                                <div class="detail-label-en">Project Of Interest</div>
                                <div class="detail-label-ar">ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑŸÖŸáÿ™ŸÖ ÿ®Ÿá</div>
                                <div class="detail-value" id="projectInterest">---</div>
                            </div>
                        </div>
                    </div>

                    <div class="prize-section">
                        <img 
                            src="https://hips.hearstapps.com/hmg-prod/images/2026-land-rover-defender-pr-101-683dc8a7ead58.jpg?crop=0.667xw:0.668xh;0.0737xw,0.188xh&resize=1200:*" 
                            alt="Defender 2026" 
                            class="prize-car-image"
                            id="prizeCarImage"
                            onerror="this.style.display='none'; document.getElementById('prizeIconFallback').style.display='block';"
                        >
                        <div class="prize-icon prize-icon-fallback" id="prizeIconFallback">üöó</div>
                        <div class="prize-label-en">The Prize</div>
                        <div class="prize-label-ar">ÿßŸÑÿ¨ÿßÿ¶ÿ≤ÿ©</div>
                        <div class="prize-text-en">Defender 2026</div>
                        <div class="prize-text-ar">ÿØŸäŸÅŸÜÿØÿ± ŸÖŸàÿØŸäŸÑ 2026</div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="download-btn" onclick="downloadWinnerInfo()">
                        üì• Download Winner Info ‚Ä¢ ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÅÿßÿ¶ÿ≤
                    </button>
                    <button class="download-btn" onclick="window.print()" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); box-shadow: 0 8px 20px rgba(33, 150, 243, 0.4);">
                        üñ®Ô∏è Print / Save as PDF ‚Ä¢ ÿ∑ÿ®ÿßÿπÿ© / ÿ≠ŸÅÿ∏ ŸÉŸÖŸÑŸÅ PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let selectedDay = null;
        let allParticipants = [];
        let selectedWinner = null;
        let previousWinners = [];

        // Configuration for draw days (Set these dates according to your schedule)
        const drawDaysConfig = {
            day1: { date: '2025-11-12', name: 'Day 1' },
            day2: { date: '2025-11-12', name: 'Day 2' },
            day3: { date: '2025-11-12', name: 'Day 3' },
            day4: { date: '2025-11-12', name: 'Day 4' }
        };

        // DOM Elements - Initialize early
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const winnerSection = document.getElementById('winnerSection');
        const loading = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const namesSection = document.getElementById('namesSection');
        const namesGrid = document.getElementById('namesGrid');
        const drawSection = document.getElementById('drawSection');
        const drawNameEl = document.getElementById('drawName');
        const drawBtn = document.getElementById('drawBtn');
        const particlesContainer = document.getElementById('particles');

        // Create floating particles
        for (let i = 0; i < 20; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.width = Math.random() * 8 + 3 + 'px';
            particle.style.height = particle.style.width;
            particle.style.left = Math.random() * 100 + '%';
            particle.style.top = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 6 + 's';
            particle.style.animationDuration = Math.random() * 4 + 4 + 's';
            particlesContainer.appendChild(particle);
        }

        // Wait for Firebase to be loaded
        function initializeFirebase() {
            if (!window.firebaseAuth || !window.firebaseAuthFunctions) {
                console.error('Firebase not loaded yet, retrying...');
                setTimeout(initializeFirebase, 100);
                return;
            }

            // Authentication state listener
            window.firebaseAuthFunctions.onAuthStateChanged(window.firebaseAuth, (user) => {
                if (user) {
                    currentUser = user;
                    showMainContent();
                } else {
                    currentUser = null;
                    showLoginSection();
                }
            });
        }

        // Login handler
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            const loginBtn = document.getElementById('loginBtn');
            
            loginBtn.disabled = true;
            loginBtn.textContent = '‚è≥ Logging in... ‚Ä¢ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ...';
            
            try {
                await window.firebaseAuthFunctions.signInWithEmailAndPassword(
                    window.firebaseAuth,
                    email,
                    password
                );
                // User will be redirected automatically by auth state listener
            } catch (error) {
                showError('Login failed: ' + error.message + ' ‚Ä¢ ŸÅÿ¥ŸÑ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ');
                loginBtn.disabled = false;
                loginBtn.textContent = 'üîë Login ‚Ä¢ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ';
            }
        }

        // Logout handler
        async function handleLogout() {
            try {
                await window.firebaseAuthFunctions.signOut(window.firebaseAuth);
                location.reload();
            } catch (error) {
                showError('Logout failed: ' + error.message);
            }
        }

        // Show/hide sections based on auth state
        function showLoginSection() {
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
        }

        function showMainContent() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'block';
            initializeApp();
        }

        // Initialize the app after authentication
        async function initializeApp() {
            await loadPreviousWinners();
            await updateDayButtons();
        }

        // Load previous winners from Firestore
        async function loadPreviousWinners() {
            try {
                const winnersRef = window.firestoreFunctions.collection(window.firebaseDb, 'winners');
                const winnersSnapshot = await window.firestoreFunctions.getDocs(winnersRef);
                
                previousWinners = [];
                const previousWinnersList = document.getElementById('previousWinnersList');
                previousWinnersList.innerHTML = '';

                if (!winnersSnapshot.empty) {
                    document.getElementById('previousWinnersSection').style.display = 'block';
                    
                    winnersSnapshot.forEach((doc) => {
                        const winner = doc.data();
                        previousWinners.push(winner);
                        
                        const winnerItem = document.createElement('div');
                        winnerItem.className = 'winner-item';
                        winnerItem.innerHTML = `
                            <div class="winner-day">${winner.day}</div>
                            <div class="winner-name-item">${winner.name}</div>
                        `;
                        previousWinnersList.appendChild(winnerItem);
                    });
                } else {
                    document.getElementById('previousWinnersSection').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading previous winners:', error);
            }
        }

        // Update day buttons based on completed draws
        async function updateDayButtons() {
            for (let i = 1; i <= 4; i++) {
                const dayBtn = document.getElementById(`day${i}Btn`);
                const dayDoc = await window.firestoreFunctions.getDoc(
                    window.firestoreFunctions.doc(window.firebaseDb, 'daysInfo', `day${i}`)
                );
                
                if (dayDoc.exists()) {
                    const dayData = dayDoc.data();
                    if (dayData.winner) {
                        dayBtn.classList.add('completed');
                        dayBtn.disabled = false;
                    }
                }
            }
        }

        // Select a day
        async function selectDay(day) {
            selectedDay = day;
            const dayConfig = drawDaysConfig[`day${day}`];
            const today = new Date().toISOString().split('T')[0];
            
            // Update day button states
            for (let i = 1; i <= 4; i++) {
                const btn = document.getElementById(`day${i}Btn`);
                if (i === day) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }

            // Check if this day's draw is already completed
            const dayDocRef = window.firestoreFunctions.doc(window.firebaseDb, 'daysInfo', `day${day}`);
            const dayDoc = await window.firestoreFunctions.getDoc(dayDocRef);
            
            if (dayDoc.exists() && dayDoc.data().winner) {
                showDayInfo(`‚úÖ Day ${day} draw already completed ‚Ä¢ ÿ™ŸÖ ÿ•ŸÉŸÖÿßŸÑ ÿ≥ÿ≠ÿ® ÿßŸÑŸäŸàŸÖ ${day}`, 'success');
                displayCompletedDayWinner(dayDoc.data());
                return;
            }

            // Check if it's the correct date to upload for this day
            if (today !== dayConfig.date) {
                showDayInfo(
                    `‚ö†Ô∏è You can only upload for Day ${day} on ${dayConfig.date} ‚Ä¢ ŸäŸÖŸÉŸÜŸÉ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ŸÅŸÇÿ∑ ŸÅŸä ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ${dayConfig.date}`,
                    'warning'
                );
                document.querySelector('.upload-section').style.display = 'none';
                return;
            }

            // Show upload section for the selected day
            showDayInfo(`‚úì Day ${day} selected - ${dayConfig.date} ‚Ä¢ ÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸäŸàŸÖ ${day}`, 'success');
            document.querySelector('.upload-section').style.display = 'block';
            document.getElementById('namesSection').style.display = 'none';
            document.getElementById('drawSection').style.display = 'none';
            document.getElementById('winnerSection').style.display = 'none';
        }

        // Show day information
        function showDayInfo(message, type) {
            const dayInfo = document.getElementById('dayInfo');
            const dayInfoText = document.getElementById('dayInfoText');
            dayInfo.style.display = 'block';
            dayInfoText.textContent = message;
            
            if (type === 'warning') {
                dayInfo.style.background = '#fff3cd';
                dayInfo.style.borderColor = '#ffc107';
            } else if (type === 'success') {
                dayInfo.style.background = '#d4edda';
                dayInfo.style.borderColor = '#28a745';
            }
        }

        // Display completed day winner
        function displayCompletedDayWinner(dayData) {
            document.querySelector('.upload-section').style.display = 'none';
            document.getElementById('namesSection').style.display = 'none';
            document.getElementById('drawSection').style.display = 'none';
            document.getElementById('winnerSection').style.display = 'block';
            
            // Reset optional fields
            document.getElementById('leadNumberRow').style.display = 'none';
            document.getElementById('projectRow').style.display = 'none';
            
            selectedWinner = dayData.winner;
            
            // Show modal for completed day winner
            const nameKey = Object.keys(dayData.winner).find(k => 
                k.toLowerCase().includes('name') || k.toLowerCase().includes('ÿßÿ≥ŸÖ')
            ) || 'name';
            const winnerName = dayData.winner[nameKey] || dayData.winner.name || 'Winner';
            
            showWinnerModal(winnerName);
            displayWinner(dayData.winner);
        }

        // Show winner modal popup
        function showWinnerModal(winnerName) {
            const modal = document.getElementById('winnerModal');
            const modalWinnerName = document.getElementById('modalWinnerName');
            
            modalWinnerName.textContent = winnerName;
            modal.classList.add('show');
            
            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
        }

        // Close winner modal
        function closeWinnerModal() {
            const modal = document.getElementById('winnerModal');
            modal.classList.remove('show');
            
            // Restore body scroll
            document.body.style.overflow = 'auto';
            
            // Scroll to winner section
            setTimeout(() => {
                winnerSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        }

        // Setup drag and drop functionality
        function setupDragAndDrop() {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.add('dragover');
                });
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.remove('dragover');
                });
            });

            uploadArea.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });
            
            // Close modal when clicking outside or pressing ESC
            const modal = document.getElementById('winnerModal');
            
            // Close on click outside modal content
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeWinnerModal();
                }
            });
            
            // Close on ESC key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && modal.classList.contains('show')) {
                    closeWinnerModal();
                }
            });
        }

        function handleFile(event) {
            const file = event.target.files[0];
            if (file) {
                handleFileUpload(file);
            }
        }

        function handleFileUpload(file) {
            if (!selectedDay) {
                showError('Please select a day first! ‚Ä¢ ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸäŸàŸÖ ÿ£ŸàŸÑÿßŸã!');
                return;
            }

            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showError('Please upload a valid Excel file ‚Ä¢ ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ ÿ•ŸÉÿ≥ŸÑ ÿµÿ≠Ÿäÿ≠');
                return;
            }

            loading.style.display = 'block';
            errorDiv.style.display = 'none';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    loading.style.display = 'none';
                    
                    if (jsonData.length === 0) {
                        showError('No data found in Excel file ‚Ä¢ ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä ÿßŸÑŸÖŸÑŸÅ');
                        return;
                    }

                    // Remove duplicates by mobile number
                    const { uniqueParticipants, duplicatesCount } = removeDuplicatesByMobile(jsonData);
                    
                    // Exclude previous winners
                    const { eligibleParticipants, excludedWinners } = excludePreviousWinners(uniqueParticipants);
                    
                    if (eligibleParticipants.length === 0) {
                        showError('No eligible participants after excluding previous winners! ‚Ä¢ ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ¥ÿßÿ±ŸÉŸäŸÜ ŸÖÿ§ŸáŸÑŸäŸÜ ÿ®ÿπÿØ ÿßÿ≥ÿ™ÿ®ÿπÿßÿØ ÿßŸÑŸÅÿßÿ¶ÿ≤ŸäŸÜ ÿßŸÑÿ≥ÿßÿ®ŸÇŸäŸÜ!');
                        return;
                    }
                    
                    allParticipants = eligibleParticipants;
                    displayAllNames(eligibleParticipants, duplicatesCount, excludedWinners);
                    
                    // Save participants count to Firestore
                    saveDayInfo(eligibleParticipants.length);
                } catch (error) {
                    loading.style.display = 'none';
                    showError('Error reading file ‚Ä¢ ÿÆÿ∑ÿ£ ŸÅŸä ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function removeDuplicatesByMobile(participants) {
            const mobileKey = Object.keys(participants[0] || {}).find(k => 
                k.toLowerCase().includes('mobile') || 
                k.toLowerCase().includes('phone') || 
                k.toLowerCase().includes('ÿ¨ŸàÿßŸÑ') ||
                k.toLowerCase().includes('Ÿáÿßÿ™ŸÅ')
            );

            if (!mobileKey) {
                return { uniqueParticipants: participants, duplicatesCount: 0 };
            }

            const seen = new Set();
            const uniqueParticipants = [];
            let duplicatesCount = 0;

            participants.forEach(participant => {
                const mobile = participant[mobileKey];
                const normalizedMobile = normalizeMobileNumber(mobile);
                
                if (normalizedMobile && !seen.has(normalizedMobile)) {
                    seen.add(normalizedMobile);
                    participant._normalizedMobile = normalizedMobile;
                    uniqueParticipants.push(participant);
                } else if (normalizedMobile && seen.has(normalizedMobile)) {
                    duplicatesCount++;
                }
            });

            return { uniqueParticipants, duplicatesCount };
        }

        // Helper function to normalize mobile numbers for comparison
        function normalizeMobileNumber(mobile) {
            if (!mobile) return null;
            const cleaned = String(mobile).replace(/[\s\-\(\)\+]/g, '');
            const normalized = cleaned.replace(/^(00966|966|0+)/, '');
            return normalized || cleaned;
        }

        // Exclude previous winners from current participants
        function excludePreviousWinners(participants) {
            const mobileKey = Object.keys(participants[0] || {}).find(k => 
                k.toLowerCase().includes('mobile') || 
                k.toLowerCase().includes('phone') || 
                k.toLowerCase().includes('ÿ¨ŸàÿßŸÑ') ||
                k.toLowerCase().includes('Ÿáÿßÿ™ŸÅ')
            );

            const nameKey = Object.keys(participants[0] || {}).find(k => 
                k.toLowerCase().includes('name') || k.toLowerCase().includes('ÿßÿ≥ŸÖ')
            ) || Object.keys(participants[0] || {})[0];

            if (!mobileKey || previousWinners.length === 0) {
                return { eligibleParticipants: participants, excludedWinners: [] };
            }

            const winnerMobilesMap = new Map();
            previousWinners.forEach(winner => {
                const normalizedWinnerMobile = normalizeMobileNumber(winner.mobile);
                if (normalizedWinnerMobile) {
                    winnerMobilesMap.set(normalizedWinnerMobile, winner);
                }
            });

            const eligibleParticipants = [];
            const excludedWinners = [];

            participants.forEach(participant => {
                const mobile = participant[mobileKey];
                const normalizedMobile = participant._normalizedMobile || normalizeMobileNumber(mobile);
                
                if (normalizedMobile && winnerMobilesMap.has(normalizedMobile)) {
                    const previousWinner = winnerMobilesMap.get(normalizedMobile);
                    excludedWinners.push({
                        name: participant[nameKey] || 'Unknown',
                        wonOn: previousWinner.day,
                        mobile: mobile
                    });
                } else if (normalizedMobile) {
                    eligibleParticipants.push(participant);
                } else {
                    eligibleParticipants.push(participant);
                }
            });

            return { eligibleParticipants, excludedWinners };
        }

        // Save day info to Firestore
        async function saveDayInfo(participantsCount) {
            try {
                const dayDocRef = window.firestoreFunctions.doc(
                    window.firebaseDb,
                    'daysInfo',
                    `day${selectedDay}`
                );
                
                await window.firestoreFunctions.setDoc(dayDocRef, {
                    day: `Day ${selectedDay}`,
                    date: drawDaysConfig[`day${selectedDay}`].date,
                    uploadTimestamp: window.firestoreFunctions.serverTimestamp(),
                    participantsCount: participantsCount,
                    winner: null
                }, { merge: true });
            } catch (error) {
                console.error('Error saving day info:', error);
            }
        }

        function displayAllNames(participants, duplicatesCount, excludedWinners) {
            document.querySelector('.upload-section').style.display = 'none';
            namesSection.style.display = 'block';
            
            document.getElementById('totalCount').textContent = participants.length;
            
            const eligibleCount = document.getElementById('eligibleCount');
            if (excludedWinners && excludedWinners.length > 0) {
                eligibleCount.style.display = 'block';
                eligibleCount.innerHTML = `
                    ‚úÖ <strong>${participants.length}</strong> Eligible Participants in Draw<br>
                    <span style="font-size: 0.9em;">‚úÖ <strong>${participants.length}</strong> ŸÖÿ¥ÿßÿ±ŸÉ ŸÖÿ§ŸáŸÑ ŸÅŸä ÿßŸÑÿ≥ÿ≠ÿ®</span>
                `;
            } else {
                eligibleCount.style.display = 'none';
            }
            
            const duplicatesInfo = document.getElementById('duplicatesInfo');
            let infoHtml = '';
            
            if (duplicatesCount > 0) {
                infoHtml += `‚ö†Ô∏è <strong>${duplicatesCount}</strong> duplicate${duplicatesCount > 1 ? 's' : ''} removed (same mobile number)<br>
                    <span style="font-size: 0.9em;">ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© <strong>${duplicatesCount}</strong> ŸÖŸÉÿ±ÿ± (ŸÜŸÅÿ≥ ÿ±ŸÇŸÖ ÿßŸÑÿ¨ŸàÿßŸÑ)</span>`;
            }
            
            if (infoHtml) {
                duplicatesInfo.style.display = 'block';
                duplicatesInfo.innerHTML = infoHtml;
            } else {
                duplicatesInfo.style.display = 'none';
            }

            if (excludedWinners && excludedWinners.length > 0) {
                let excludedHtml = `
                    <div class="excluded-winners-section">
                        <div class="excluded-winners-title">
                            üö´ Excluded from Draw ‚Ä¢ ŸÖÿ≥ÿ™ÿ®ÿπÿØŸàŸÜ ŸÖŸÜ ÿßŸÑÿ≥ÿ≠ÿ®
                        </div>
                        <div style="font-size: 1em; color: #721c24; margin-bottom: 20px; font-weight: 600;">
                            ${excludedWinners.length} participant${excludedWinners.length > 1 ? 's' : ''} excluded because they already won:
                            <br>
                            <span style="direction: rtl; display: block; margin-top: 5px;">ÿ™ŸÖ ÿßÿ≥ÿ™ÿ®ÿπÿßÿØ ${excludedWinners.length} ŸÖÿ¥ÿßÿ±ŸÉ${excludedWinners.length > 1 ? 'ŸäŸÜ' : ''} ŸÑÿ£ŸÜŸáŸÖ ŸÅÿßÿ≤Ÿàÿß ÿ≥ÿßÿ®ŸÇÿßŸã:</span>
                        </div>
                `;
                
                excludedWinners.forEach((excluded, index) => {
                    excludedHtml += `
                        <div class="excluded-winner-item" style="animation-delay: ${index * 0.1}s">
                            <div class="excluded-winner-main">
                                <div class="excluded-winner-icon">üö´</div>
                                <div class="excluded-winner-name">${excluded.name}</div>
                            </div>
                            <div class="excluded-winner-message">
                                <strong>${excluded.name}</strong> excluded as he/she is the Winner of <strong>${excluded.wonOn}</strong>
                            </div>
                            <div class="excluded-winner-message-ar">
                                ÿ™ŸÖ ÿßÿ≥ÿ™ÿ®ÿπÿßÿØ <strong>${excluded.name}</strong> ŸÑÿ£ŸÜŸá/ŸÑÿ£ŸÜŸáÿß ÿßŸÑŸÅÿßÿ¶ÿ≤ ŸÅŸä <strong>${excluded.wonOn}</strong>
                            </div>
                        </div>
                    `;
                });
                
                excludedHtml += `
                    <div style="margin-top: 15px; padding: 15px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">
                        <strong style="color: #721c24;">‚ö†Ô∏è Important:</strong> These ${excludedWinners.length} person${excludedWinners.length > 1 ? 's are' : ' is'} <strong>NOT included</strong> in the draw animation below.
                        <br>
                        <span style="direction: rtl; display: block; margin-top: 8px; color: #721c24;">
                            <strong>‚ö†Ô∏è ŸÖŸáŸÖ:</strong> Ÿáÿ§ŸÑÿßÿ° ÿßŸÑŸÄ ${excludedWinners.length} ŸÖÿ¥ÿßÿ±ŸÉ${excludedWinners.length > 1 ? 'ŸäŸÜ' : ''} <strong>ÿ∫Ÿäÿ± ŸÖÿ¥ŸÖŸàŸÑŸäŸÜ</strong> ŸÅŸä ÿßŸÑÿ≥ÿ≠ÿ® ÿ£ÿØŸÜÿßŸá.
                        </span>
                    </div>
                </div>`;
                
                if (duplicatesInfo.innerHTML) {
                    duplicatesInfo.innerHTML += excludedHtml;
                } else {
                    duplicatesInfo.style.display = 'block';
                    duplicatesInfo.innerHTML = excludedHtml;
                }
            }
            
            namesGrid.innerHTML = '';
            
            participants.forEach((participant, index) => {
                const nameKey = Object.keys(participant).find(k => 
                    k.toLowerCase().includes('name') || k.toLowerCase().includes('ÿßÿ≥ŸÖ')
                ) || Object.keys(participant)[0];
                const name = participant[nameKey] || `Participant ${index + 1}`;
                
                const nameItem = document.createElement('div');
                nameItem.className = 'name-item';
                nameItem.textContent = name;
                nameItem.style.animationDelay = `${index * 0.05}s`;
                namesGrid.appendChild(nameItem);
            });
            
            namesSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function startDraw() {
            namesSection.style.display = 'none';
            drawSection.style.display = 'block';
            drawBtn.disabled = true;
            drawNameEl.classList.add('spinning');
            
            let counter = 0;
            const maxSpins = 30;
            const spinInterval = 100;
            
            const spinTimer = setInterval(() => {
                const randomIndex = Math.floor(Math.random() * allParticipants.length);
                const participant = allParticipants[randomIndex];
                const nameKey = Object.keys(participant).find(k => 
                    k.toLowerCase().includes('name') || k.toLowerCase().includes('ÿßÿ≥ŸÖ')
                ) || Object.keys(participant)[0];
                drawNameEl.textContent = participant[nameKey];
                
                counter++;
                
                if (counter >= maxSpins) {
                    clearInterval(spinTimer);
                    slowDownAndSelect();
                }
            }, spinInterval);
        }

        function slowDownAndSelect() {
            let slowCounter = 0;
            const slowSpins = 10;
            let currentDelay = 150;
            
            function slowSpin() {
                if (slowCounter >= slowSpins) {
                    selectFinalWinner();
                    return;
                }
                
                const randomIndex = Math.floor(Math.random() * allParticipants.length);
                const participant = allParticipants[randomIndex];
                const nameKey = Object.keys(participant).find(k => 
                    k.toLowerCase().includes('name') || k.toLowerCase().includes('ÿßÿ≥ŸÖ')
                ) || Object.keys(participant)[0];
                drawNameEl.textContent = participant[nameKey];
                
                slowCounter++;
                currentDelay += 50;
                setTimeout(slowSpin, currentDelay);
            }
            
            slowSpin();
        }

        async function selectFinalWinner() {
            const winnerIndex = Math.floor(Math.random() * allParticipants.length);
            selectedWinner = allParticipants[winnerIndex];
            
            const nameKey = Object.keys(selectedWinner).find(k => 
                k.toLowerCase().includes('name') || k.toLowerCase().includes('ÿßÿ≥ŸÖ')
            ) || Object.keys(selectedWinner)[0];
            
            drawNameEl.classList.remove('spinning');
            drawNameEl.textContent = selectedWinner[nameKey];
            
            // Save winner to Firestore
            await saveWinner(selectedWinner);
            
            setTimeout(() => {
                drawSection.style.display = 'none';
                
                // Show modal popup first
                showWinnerModal(selectedWinner[nameKey]);
                
                // Prepare winner card in background
                displayWinner(selectedWinner);
                
                // Create confetti
                createConfetti();
            }, 2000);
        }

        // Save winner to Firestore
        async function saveWinner(winnerData) {
            try {
                const nameKey = Object.keys(winnerData).find(k => 
                    k.toLowerCase().includes('name') || k.toLowerCase().includes('ÿßÿ≥ŸÖ')
                ) || Object.keys(winnerData)[0];
                const winnerName = winnerData[nameKey] || 'Winner';

                const mobileKey = Object.keys(winnerData).find(k => 
                    k.toLowerCase().includes('mobile') || 
                    k.toLowerCase().includes('phone') || 
                    k.toLowerCase().includes('ÿ¨ŸàÿßŸÑ') ||
                    k.toLowerCase().includes('Ÿáÿßÿ™ŸÅ')
                );
                const mobileNumber = mobileKey ? String(winnerData[mobileKey]) : 'N/A';
                const normalizedMobile = normalizeMobileNumber(mobileNumber);

                const leadKey = Object.keys(winnerData).find(k => 
                    k.toLowerCase().includes('lead') ||
                    k.toLowerCase().includes('ÿπŸÖŸäŸÑ')
                );
                const leadNumber = leadKey ? winnerData[leadKey] : 'N/A';

                const projectKey = Object.keys(winnerData).find(k => 
                    k.toLowerCase().includes('project') ||
                    k.toLowerCase().includes('interest') ||
                    k.toLowerCase().includes('ŸÖÿ¥ÿ±Ÿàÿπ')
                );
                const projectInterest = projectKey ? winnerData[projectKey] : 'N/A';

                const winnerObject = {
                    day: `Day ${selectedDay}`,
                    name: winnerName,
                    mobile: normalizedMobile || mobileNumber,
                    originalMobile: mobileNumber,
                    leadNumber: leadNumber,
                    projectInterest: projectInterest,
                    drawTimestamp: window.firestoreFunctions.serverTimestamp()
                };

                // Save to winners collection
                const winnerDocRef = window.firestoreFunctions.doc(
                    window.firebaseDb,
                    'winners',
                    `day${selectedDay}_winner`
                );
                await window.firestoreFunctions.setDoc(winnerDocRef, winnerObject);

                // Update day info with winner
                const dayDocRef = window.firestoreFunctions.doc(
                    window.firebaseDb,
                    'daysInfo',
                    `day${selectedDay}`
                );
                await window.firestoreFunctions.setDoc(dayDocRef, {
                    winner: winnerObject
                }, { merge: true });

                // Reload previous winners
                await loadPreviousWinners();
                await updateDayButtons();
            } catch (error) {
                console.error('Error saving winner:', error);
                showError('Error saving winner data: ' + error.message);
            }
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function maskMobileNumber(mobile) {
            const cleanMobile = String(mobile).replace(/\s+/g, '');
            
            if (cleanMobile.length < 7) {
                return cleanMobile;
            }
            
            const firstPart = cleanMobile.substring(0, 3);
            const lastPart = cleanMobile.substring(cleanMobile.length - 3);
            const middleLength = cleanMobile.length - 6;
            const maskedMiddle = '*'.repeat(middleLength);
            
            return `${firstPart}${maskedMiddle}${lastPart}`;
        }

        function displayWinner(winnerData) {
            // Reset optional fields
            document.getElementById('leadNumberRow').style.display = 'none';
            document.getElementById('projectRow').style.display = 'none';
            document.getElementById('leadNumber').textContent = '---';
            document.getElementById('projectInterest').textContent = '---';
            
            const nameKey = Object.keys(winnerData).find(k => 
                k.toLowerCase().includes('name') || k.toLowerCase().includes('ÿßÿ≥ŸÖ')
            ) || Object.keys(winnerData)[0];
            const winnerName = winnerData[nameKey] || winnerData.name || 'Winner';
            document.getElementById('winnerName').textContent = winnerName;

            const displayMobile = winnerData.originalMobile || winnerData.mobile;
            
            const mobileKey = Object.keys(winnerData).find(k => 
                k.toLowerCase().includes('mobile') || 
                k.toLowerCase().includes('phone') || 
                k.toLowerCase().includes('ÿ¨ŸàÿßŸÑ') ||
                k.toLowerCase().includes('Ÿáÿßÿ™ŸÅ')
            );
            
            if (displayMobile) {
                const maskedMobile = maskMobileNumber(displayMobile);
                document.getElementById('mobileNumber').textContent = maskedMobile;
            } else if (mobileKey && winnerData[mobileKey]) {
                const fullMobile = String(winnerData[mobileKey]);
                const maskedMobile = maskMobileNumber(fullMobile);
                document.getElementById('mobileNumber').textContent = maskedMobile;
            }

            const leadKey = Object.keys(winnerData).find(k => 
                k.toLowerCase().includes('lead') ||
                k.toLowerCase().includes('ÿπŸÖŸäŸÑ')
            );
            if ((leadKey && winnerData[leadKey]) || winnerData.leadNumber) {
                const leadNum = winnerData[leadKey] || winnerData.leadNumber;
                if (leadNum !== 'N/A') {
                    document.getElementById('leadNumber').textContent = leadNum;
                    document.getElementById('leadNumberRow').style.display = 'flex';
                }
            }

            const projectKey = Object.keys(winnerData).find(k => 
                k.toLowerCase().includes('project') ||
                k.toLowerCase().includes('interest') ||
                k.toLowerCase().includes('ŸÖÿ¥ÿ±Ÿàÿπ')
            );
            if ((projectKey && winnerData[projectKey]) || winnerData.projectInterest) {
                const project = winnerData[projectKey] || winnerData.projectInterest;
                if (project !== 'N/A') {
                    document.getElementById('projectInterest').textContent = project;
                    document.getElementById('projectRow').style.display = 'flex';
                }
            }

            winnerSection.style.display = 'block';
        }

        function createConfetti() {
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.top = '-10px';
                    confetti.style.background = ['#F27935', '#FFD700', '#FF6B6B', '#4ECDC4'][Math.floor(Math.random() * 4)];
                    confetti.style.animationDelay = Math.random() * 2 + 's';
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 50);
            }
        }

        function downloadWinnerInfo() {
            if (!selectedWinner) {
                alert('No winner selected yet! ‚Ä¢ ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ŸÅÿßÿ¶ÿ≤ ÿ®ÿπÿØ!');
                return;
            }

            const nameKey = Object.keys(selectedWinner).find(k => 
                k.toLowerCase().includes('name') || k.toLowerCase().includes('ÿßÿ≥ŸÖ')
            ) || Object.keys(selectedWinner)[0];
            const winnerName = selectedWinner[nameKey] || selectedWinner.name || 'Winner';

            const displayMobile = selectedWinner.originalMobile || selectedWinner.mobile;
            
            const mobileKey = Object.keys(selectedWinner).find(k => 
                k.toLowerCase().includes('mobile') || 
                k.toLowerCase().includes('phone') || 
                k.toLowerCase().includes('ÿ¨ŸàÿßŸÑ') ||
                k.toLowerCase().includes('Ÿáÿßÿ™ŸÅ')
            );
            const mobileNumber = displayMobile || (mobileKey ? selectedWinner[mobileKey] : 'N/A') || 'N/A';

            const leadKey = Object.keys(selectedWinner).find(k => 
                k.toLowerCase().includes('lead') ||
                k.toLowerCase().includes('ÿπŸÖŸäŸÑ')
            );
            const leadNumber = leadKey ? selectedWinner[leadKey] : (selectedWinner.leadNumber || 'N/A');

            const projectKey = Object.keys(selectedWinner).find(k => 
                k.toLowerCase().includes('project') ||
                k.toLowerCase().includes('interest') ||
                k.toLowerCase().includes('ŸÖÿ¥ÿ±Ÿàÿπ')
            );
            const projectInterest = projectKey ? selectedWinner[projectKey] : (selectedWinner.projectInterest || 'N/A');

            const currentDate = new Date().toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const content = `
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
          CITY SCAPE 2025 WINNER ANNOUNCEMENT
                    ÿ•ÿπŸÑÿßŸÜ ÿßŸÑŸÅÿßÿ¶ÿ≤
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üèÜ WINNER INFORMATION / ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÅÿßÿ¶ÿ≤
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

üìõ Winner Name / ÿßÿ≥ŸÖ ÿßŸÑŸÅÿßÿ¶ÿ≤:
   ${winnerName}

üì± Mobile Number / ÿ±ŸÇŸÖ ÿßŸÑÿ¨ŸàÿßŸÑ:
   ${mobileNumber}

${leadNumber !== 'N/A' ? `üì¢ Lead Number / ÿ±ŸÇŸÖ ÿßŸÑÿπŸÖŸäŸÑ ÿßŸÑŸÖÿ≠ÿ™ŸÖŸÑ:\n   ${leadNumber}\n\n` : ''}${projectInterest !== 'N/A' ? `üè¢ Project Of Interest / ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿßŸÑŸÖŸáÿ™ŸÖ ÿ®Ÿá:\n   ${projectInterest}\n\n` : ''}üìÖ Day / ÿßŸÑŸäŸàŸÖ:
   Day ${selectedDay}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

üéÅ PRIZE DETAILS / ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ¨ÿßÿ¶ÿ≤ÿ©
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

üöó Defender 2026
   ÿØŸäŸÅŸÜÿØÿ± ŸÖŸàÿØŸäŸÑ 2026

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

üìÖ Draw Date / ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ≥ÿ≠ÿ®:
   ${currentDate}

üè¢ Organized By / ÿ™ŸÜÿ∏ŸäŸÖ:
   Dar Wa Emaar (DWE)

‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
          üéä CONGRATULATIONS! ŸÖÿ®ÿ±ŸàŸÉ! üéä
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
`;

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `CityScape_2025_Day${selectedDay}_Winner_${winnerName.replace(/\s+/g, '_')}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Initialize Firebase when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setupDragAndDrop();
                initializeFirebase();
            });
        } else {
            setupDragAndDrop();
            initializeFirebase();
        }
    </script>
</body>
</html>
